{"version":3,"names":["cov_1e5bo04z3v","actualCoverage","s","useSMTokenExchange","f","address","isConnected","_wagmi","useAccount","isExchanging","setIsExchanging","_react","useState","txHash","setTxHash","error","setError","data","exchangeStats","isLoading","isLoadingStats","refetch","refetchStats","useReadContract","_contracts","contractAddresses","smTokenExchange","abi","contractAbis","functionName","enabled","writeContractAsync","isPending","isWritePending","useWriteContract","exchangeTokens","bnbAmount","b","Error","valueInWei","_viem","parseEther","hash","value","err","formattedStats","totalTokensSold","totalTokensRemaining","totalBnbRaised","currentPrice","nextRoundPrice","isActive","currentRound","formattedTokensSold","formatUnits","formattedTokensRemaining","formattedBnbRaised","formatEther","formattedCurrentPrice","formattedNextRoundPrice"],"sources":["/Users/yudeyou/Desktop/sm/sociomint/src/hooks/useSMTokenExchange.ts"],"sourcesContent":["import { useAccount, useReadContract, useWriteContract } from 'wagmi';\nimport { parseEther, formatEther, formatUnits } from 'viem';\nimport { useState } from 'react';\nimport { contractAbis, contractAddresses, ExchangeStats } from '../config/contracts';\n\n// 定义合约返回的原始数据类型\ntype ExchangeStatsResult = [\n  bigint, // totalTokensSold\n  bigint, // totalTokensRemaining\n  bigint, // totalBnbRaised\n  bigint, // currentPrice\n  bigint, // nextRoundPrice\n  boolean, // isActive\n  number  // currentRound\n];\n\nexport function useSMTokenExchange() {\n  const { address, isConnected } = useAccount();\n  const [isExchanging, setIsExchanging] = useState(false);\n  const [txHash, setTxHash] = useState<`0x${string}` | null>(null);\n  const [error, setError] = useState<Error | null>(null);\n\n  // 读取交易所统计信息\n  const { \n    data: exchangeStats, \n    isLoading: isLoadingStats, \n    refetch: refetchStats\n  } = useReadContract({\n    address: contractAddresses.smTokenExchange,\n    abi: contractAbis.smTokenExchange,\n    functionName: 'getExchangeStats',\n    enabled: !!contractAddresses.smTokenExchange,\n  }) as { data: ExchangeStatsResult | undefined, isLoading: boolean, refetch: () => Promise<any> };\n\n  // 准备写入合约函数\n  const { writeContractAsync, isPending: isWritePending } = useWriteContract();\n\n  // 执行代币兑换\n  const exchangeTokens = async (bnbAmount: string) => {\n    if (!isConnected || !address) {\n      setError(new Error('请先连接钱包'));\n      return;\n    }\n\n    setIsExchanging(true);\n    setError(null);\n    setTxHash(null);\n\n    try {\n      // 将BNB数量转换为Wei\n      const valueInWei = parseEther(bnbAmount);\n\n      // 调用合约的exchangeTokens函数\n      const hash = await writeContractAsync({\n        address: contractAddresses.smTokenExchange,\n        abi: contractAbis.smTokenExchange,\n        functionName: 'exchangeTokens',\n        value: valueInWei,\n      });\n\n      setTxHash(hash);\n      \n      // 交易成功后刷新数据\n      await refetchStats();\n      \n      return hash;\n    } catch (err) {\n      setError(err instanceof Error ? err : new Error('兑换失败'));\n      throw err;\n    } finally {\n      setIsExchanging(false);\n    }\n  };\n\n  // 格式化统计数据\n  const formattedStats = exchangeStats ? {\n    totalTokensSold: exchangeStats[0],\n    totalTokensRemaining: exchangeStats[1],\n    totalBnbRaised: exchangeStats[2],\n    currentPrice: exchangeStats[3],\n    nextRoundPrice: exchangeStats[4],\n    isActive: exchangeStats[5],\n    currentRound: exchangeStats[6],\n    // 添加一些格式化的值\n    formattedTokensSold: formatUnits(exchangeStats[0], 18),\n    formattedTokensRemaining: formatUnits(exchangeStats[1], 18),\n    formattedBnbRaised: formatEther(exchangeStats[2]),\n    formattedCurrentPrice: formatEther(exchangeStats[3]),\n    formattedNextRoundPrice: formatEther(exchangeStats[4]),\n  } : null;\n\n  return {\n    exchangeStats: formattedStats,\n    exchangeTokens,\n    isLoadingStats,\n    isExchanging: isExchanging || isWritePending,\n    txHash,\n    error,\n    refetchStats,\n  };\n}\n"],"mappings":"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","ignoreList":[]}